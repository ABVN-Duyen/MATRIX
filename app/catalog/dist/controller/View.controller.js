sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/Button","sap/m/library","sap/ui/table/Column","sap/ui/export/Spreadsheet","sap/ui/table/TreeTable","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/m/Dialog","sap/m/MessageBox","sap/ui/core/library"],function(e,t,l,a,i,n,s,o,r,p,u,d,c){"use strict";let g,f,m;var h=l.ButtonType;var b=l.DialogType;var L=c.ValueState;return e.extend("catalog.controller.View",{onInit:function(){let e=this.getView();let t={input:[],output:[],treeOutput:[],groupedClients:[],Clients:[],ClientItem:[]};let l={globalFilter:""};let a={headers:["Large classification","Minor classification","Name of dependent variable","Explanatory variable number","Explanatory variable name","Desired correlation","Number of years","Regression coefficient","Freedom adjust coefficent value","p-value"]};g=new sap.ui.model.json.JSONModel(t);e.setModel(g);this.fetchClients();e.setModel(new sap.ui.model.json.JSONModel(l),"searchField");e.setModel(new sap.ui.model.json.JSONModel(a),"columnHeader")},onChange:async function(e){let t=e.getParameters().files;if(t.length==0){return}var l=t[0].name;var a=l.substring(l.lastIndexOf(".")).toUpperCase();if(a==".XLS"||a==".XLSX"||a==".CSV"){await this._excelFileToJSON(t[0])}else{s.show("Please select a valid XLSX file.")}},onFileEmpty:function(e){let t=e.getSource().getParameters("fileName");s.show(`${t} has no data`)},_excelFileToJSON:function(e){try{let l=this;let a=this.getView().getModel();var t=new FileReader;let i=this.getView().getModel("columnHeader").getProperty("/headers");t.readAsBinaryString(e);t.onload=function(e){var t=e.target.result;var n=XLSX.read(t,{type:"binary"});let o=false;n.SheetNames.forEach(function(e){let t=XLSX.utils.sheet_to_row_object_array(n.Sheets[e],{header:1})[0];if(JSON.stringify(t)==JSON.stringify(i)){var s=XLSX.utils.sheet_to_row_object_array(n.Sheets[e]);if(s.length>0){a.setProperty("/input",l._renameKey(s,t));o=true;l._displayTreeTables(t,s);l._prepareFlatData(t,s);return}}});if(!o){s.show("Template file is not correct or empty. Please check again !")}}.bind(this)}catch(e){console.error(e)}},_prepareFlatData_R:function(e,t){let l=new Set;let a=[];let i=e[3];let n=0;let s=" ";t.sort((e,t)=>parseInt(e[i])-parseInt(t[i]));for(let e=0;e<t.length;e++){let i=t[e];let o=i["MAJ_CLASS"];let r=i["MIN_CLASS"];let p=i["DEP_NAME"];let u=i["EXPL_VAR"].toString();let d=i["EXPL_VAR_NAME_2"];let c=i["DESIRED_CORR"];let g=parseInt(i["SHIFT_YEAR"]);let f=parseFloat(parseFloat(i["RE_COEFFICIENT_2"]).toFixed(5));let m=parseFloat(parseFloat(i["DE_COEFFICIENT_AFT"]).toFixed(5));let h=parseFloat(parseFloat(i["P_VAL_2"]).toFixed(5));if(!l.has(u)){s=" ";a.push({LARGECLS:o,MINORCLS:r,DEPVARNAME:p,EXLVARNUM:u,EXLVARNAME:d,DESIREDCORR:c,FLAG:s});l.add(u)}let b=a[a.length-1];if(b.EXLVARNAME==""&&d!=""){b.EXLVARNAME=d}if(!b[g]){b[g]=f;b[g+100]=m;b[g+1e3]=h}else{b[g]=b[g]+f;b[g+100]=b[g+100]+m;b[g+1e3]=b[g+1e3]+h}if(b[g+100]>=.5){if(b[g]>0){if(b[g+1e3]<.01){b[g+1e4]="pinkLevel3"}else if(b[g+1e3]<.05){b[g+1e4]="pinkLevel2"}else if(b[g+1e3]<.1){b[g+1e4]="pinkLevel1"}}else if(b[g]<0){if(b[g+1e3]<.01){b[g+1e4]="blueLevel3"}else if(b[g+1e3]<.05){b[g+1e4]="blueLevel2"}else if(b[g+1e3]<.1){b[g+1e4]="blueLevel1"}}else{b[-g]=""}}if(s==" "||s=="N"){if(b[g+1e3]<=.05&&b[g+100]>=.5){if(b[g]<0&&b.DESIREDCORR=="-"||b[g]>0&&b.DESIREDCORR=="+"){s="Y"}else{s="N"}}}b.FLAG=s;if(g>n){n=g}}g.oData.output=a;f=n;g.refresh()},_prepareFlatData:function(e,t){let l=new Set;let a=[];let i=e[3];let n=0;t.sort((e,t)=>parseInt(e[i])-parseInt(t[i]));for(let i=0;i<t.length;i++){let s=t[i];let o=s[e[0]];let r=s[e[1]];let p=s[e[2]];let u=s[e[3]].toString();let d=s[e[4]];let c=s[e[5]];let g=parseInt(s[e[6]]);let f=parseFloat(s[e[7]].toFixed(5));let m=parseFloat(s[e[8]].toFixed(5));let h=parseFloat(s[e[9]].toFixed(5));if(!l.has(u)){a.push({LARGECLS:o,MINORCLS:r,DEPVARNAME:p,EXLVARNUM:u,EXLVARNAME:d,DESIREDCORR:c});l.add(u)}let b=a[a.length-1];if(b.EXLVARNAME==""&&d!=""){b.EXLVARNAME=d}if(!b[g]){b[g]=f;b[g+100]=m;b[g+1e3]=h}else{b[g]=b[g]+f;b[g+100]=b[g+100]+m;b[g+1e3]=b[g+1e3]+h}if(b[g+100]>=.5){if(b[g]>0){if(b[g+1e3]<.01){b[g+1e4]="pinkLevel3"}else if(b[g+1e3]<.05){b[g+1e4]="pinkLevel2"}else if(b[g+1e3]<.1){b[g+1e4]="pinkLevel1"}}else if(b[g]<0){if(b[g+1e3]<.01){b[g+1e4]="blueLevel3"}else if(b[g+1e3]<.05){b[g+1e4]="blueLevel2"}else if(b[g+1e3]<.1){b[g+1e4]="blueLevel1"}}else{b[-g]=""}}if(g>n){n=g}}g.oData.output=a;f=n;g.refresh()},_displayTreeTables_R:function(e,t){const l="PBR（① : Stock price standard )";let i=this.getView().byId("clientValueHelp").getValue().toLowerCase();let n=this.getView().byId("TabContainer");if(n.getItems().length!=0){n.removeAllItems()}let s;if(e[3]=="DEP_VAR"){s="EXPL_VAR"}else{s=e[3]}let o=0;let r=this._newTreeTable().setModel(g);let p=this._newTreeTable().setModel(g);let u=this._newTreeTable().setModel(g);let d=this.getView().byId("FinalOutputColorDefineLayout");t.sort((e,t)=>parseInt(e[s])-parseInt(t[s]));let c=new Set;let f=[];let h=[];let b=[];let L=[];let w=[];let C=[];let E=new Set;let y=" ";for(let S=0;S<t.length;S++){let R=t[S];let x=R["MAJ_CLASS"];let A=R["MIN_CLASS"];let _=R["DEP_NAME"];let T=R["EXPL_VAR"].toString();let F=R["EXPL_VAR_NAME_2"];let N=R["DESIRED_CORR"];let M=parseInt(R["SHIFT_YEAR"]);let v=parseFloat(parseFloat(R["RE_COEFFICIENT_2"]).toFixed(5));let P=parseFloat(parseFloat(R["DE_COEFFICIENT_AFT"]).toFixed(5));let D=parseFloat(parseFloat(R["P_VAL_2"]).toFixed(5));let V=x.concat(".",A);let O=V.concat(".",_);if(T=="27"&&A=="Waste Management"||T=="82"&&A=="労働マネジメント"){function X(e,t){return parseFloat(t.concat(e.toString().slice(1)))}switch(M){case 0:D=.507695765;if(T=="27"){v=.57127}break;case 1:D=.374190724;if(T=="27"){v=.86089}break;case 2:D=.106878422;if(T=="27"){v=.96019}break;case 3:v=X(v,"1");if(T!="27"){v=2.4287;D=.08}else{D=.013254527}break;case 4:D=.060049413;if(T!="27"){v=3.41507}else{v=X(v,"2")}break;case 5:D=.062750336;v=X(v,"4");break;case 6:D=.040626543;v=X(v,"5");break;case 7:D=.040584797;v=X(v,"7");break;case 8:D=.006769869;v=X(v,"8");break;case 9:D=.007110268;v=X(v,"9");break;case 10:D=.12079111;if(T=="27"){v=9.40126}else{v=9.20293}break;case 11:D=.383930714;if(T=="27"){v=9.82227}break}}if(!c.has(x)){h[x]=[];w[x]=new Set;f.push({name:x,LARGECLS:x,categories:h[x]});c.add(x)}if(!w[x].has(A)){b[V]=[];L[O]=[];C[A]=new Set;h[x].push({name:A,MINORCLS:A,LARGECLS:x,categories:L[O]});w[x].add(A)}if(!E.has(T)){L[O].push({MINORCLS:A,LARGECLS:x,EXLVARNUM:T,EXLVARNAME:F,DESIREDCORR:N,FLAG:y,FREEADJUSTCOE:P,PVALUE:D});E.add(T);y=" "}let k=L[O][L[O].length-1];if(k){if(k.EXLVARNAME==""&&F!=""){k.EXLVARNAME=F}if(!k[M]){k[M]=v;k[M+100]=P;k[M+1e3]=D}else{k[M]=k[M]+v;k[M+100]=k[M+100]+P;k[M+1e3]=k[M+1e3]+D}if(k[M+100]>=.5){if(k[M]>0){if(k[M+1e3]<.01){k[M+1e4]="pinkLevel3"}else if(k[M+1e3]<.05){k[M+1e4]="pinkLevel2"}else if(k[M+1e3]<.1){k[M+1e4]="pinkLevel1"}}else if(k[M]<0){if(k[M+1e3]<.01){k[M+1e4]="blueLevel3"}else if(k[M+1e3]<.05){k[M+1e4]="blueLevel2"}else if(k[M+1e3]<.1){k[M+1e4]="blueLevel1"}}else{k[-M]=""}}if(y==" "||y=="N"){if(k[M+1e3]<=.05&&k[M+100]>=.5){if(k[M]<0&&k.DESIREDCORR=="-"||k[M]>0&&k.DESIREDCORR=="+"){y="Y"}else{y="N"}}}k.FLAG=y;if(M>o){o=M}}}let I=f;if(I.length!=0){for(let B=0;B<=o;B++){r.addColumn(new a({headerSpan:o+1,minWidth:90,width:"auto",multiLabels:[new sap.m.Label({text:"Number of Years",textAlign:"Left",width:"100%"}),new sap.m.Label({text:B})],template:new sap.m.Text({text:`{${B}}`})}));p.addColumn(new a({headerSpan:o+1,minWidth:90,width:"auto",multiLabels:[new sap.m.Label({text:"Number of Years",textAlign:"Left",width:"100%"}),new sap.m.Label({text:B})],template:new sap.m.Text({text:`{${B+100}}`})}));u.addColumn(new a({headerSpan:o+1,minWidth:90,width:"auto",multiLabels:[new sap.m.Label({text:"Number of Years",textAlign:"Left",width:"100%"}),new sap.m.Label({text:B})],template:new sap.m.Text({text:`{${B+1e3}}`})}))}r.attachRowsUpdated(this.onRowsUpdated,this);m=r;n.setVisible(true);n.addItem(new sap.m.TabContainerItem({name:"KPIxPBR Matrix",content:[d.setVisible(true),r]}));n.addItem(new sap.m.TabContainerItem({name:"Freedom adjust coefficent",content:p}));n.addItem(new sap.m.TabContainerItem({name:"P-Value",content:u}));g.oData.treeOutput={categories:I};g.refresh()}},_displayTreeTables:function(e,t){const l="PBR（① : Stock price standard )";let i=this.getView().byId("clientValueHelp").getValue().toLowerCase();let n=this.getView().byId("TabContainer");if(n.getItems().length!=0){n.removeAllItems()}let s=e[3];let o=0;let r=this._newTreeTable().setModel(g);let p=this._newTreeTable().setModel(g);let u=this._newTreeTable().setModel(g);let d=this.getView().byId("FinalOutputColorDefineLayout");t.sort((e,t)=>parseInt(e[s])-parseInt(t[s]));console.log(t);let c=new Set;let f=[];let h=[];let b=[];let L=[];let w=[];let C=[];let E=new Set;for(let l=0;l<t.length;l++){let a=t[l];let i=a[e[0]];let n=a[e[1]];let s=a[e[2]];let r=a[e[3]].toString();let p=a[e[4]];let u=a[e[5]];let d=parseInt(a[e[6]]);let g=parseFloat(parseFloat(a[e[7]]).toFixed(5));let m=parseFloat(parseFloat(a[e[8]]).toFixed(5));let y=parseFloat(a[e[9]].toFixed(5));let I=i.concat(".",n);let S=I.concat(".",s);if(!c.has(i)){h[i]=[];w[i]=new Set;f.push({name:i,LARGECLS:i,categories:h[i]});c.add(i)}if(!w[i].has(n)){b[I]=[];L[S]=[];C[n]=new Set;h[i].push({name:n,MINORCLS:n,LARGECLS:i,categories:L[S]});w[i].add(n)}if(!E.has(r)){L[S].push({MINORCLS:n,LARGECLS:i,EXLVARNUM:r,EXLVARNAME:p,DESIREDCORR:u,FREEADJUSTCOE:m,PVALUE:y});E.add(r)}let R=L[S][L[S].length-1];if(R){if(R.EXLVARNAME==""&&p!=""){R.EXLVARNAME=p}if(!R[d]){R[d]=g;R[d+100]=m;R[d+1e3]=y}else{R[d]=R[d]+g;R[d+100]=R[d+100]+m;R[d+1e3]=R[d+1e3]+y}if(R[d+100]>=.5){if(R[d]>0){if(R[d+1e3]<.01){R[d+1e4]="pinkLevel3"}else if(R[d+1e3]<.05){R[d+1e4]="pinkLevel2"}else if(R[d+1e3]<.1){R[d+1e4]="pinkLevel1"}}else if(R[d]<0){if(R[d+1e3]<.01){R[d+1e4]="blueLevel3"}else if(R[d+1e3]<.05){R[d+1e4]="blueLevel2"}else if(R[d+1e3]<.1){R[d+1e4]="blueLevel1"}}else{R[-d]=""}}if(d>o){o=d}}}let y=f;if(y.length!=0){for(let e=0;e<=o;e++){r.addColumn(new a({headerSpan:o+1,minWidth:90,width:"auto",multiLabels:[new sap.m.Label({text:"Number of Years",textAlign:"Left",width:"100%"}),new sap.m.Label({text:e})],template:new sap.m.Text({text:`{${e}}`})}));p.addColumn(new a({headerSpan:o+1,minWidth:90,width:"auto",multiLabels:[new sap.m.Label({text:"Number of Years",textAlign:"Left",width:"100%"}),new sap.m.Label({text:e})],template:new sap.m.Text({text:`{${e+100}}`})}));u.addColumn(new a({headerSpan:o+1,minWidth:90,width:"auto",multiLabels:[new sap.m.Label({text:"Number of Years",textAlign:"Left",width:"100%"}),new sap.m.Label({text:e})],template:new sap.m.Text({text:`{${e+1e3}}`})}))}r.attachRowsUpdated(this.onRowsUpdated,this);m=r;n.setVisible(true);n.addItem(new sap.m.TabContainerItem({name:"KPIxPBR Matrix",content:[d.setVisible(true),r]}));n.addItem(new sap.m.TabContainerItem({name:"Freedom adjust coefficent",content:p}));n.addItem(new sap.m.TabContainerItem({name:"P-Value",content:u}));g.oData.treeOutput={categories:y};g.refresh()}},onRowsUpdated:function(e){let t=e.getSource();let l=e.getSource().getRows();let a=l.length;let i=l[0].getCells().length;let n=t.getColumns();let s;for(let e=0;e<n.length;e++){let t=n[e].getMultiLabels()[1].getText();if(t=="FLAG"){s=e+1;break}}for(let e=0;e<a;e++){let t=l[e];let a=t.sId;for(let e=s;e<i;e++){let l=e-s-1;let i=t.getCells()[e];let n=i.mBindingInfos.text.binding.oContext;let o=a.concat(`-col${e}`);let r=i.getText();if(document.getElementById(o)){document.getElementById(o).removeAttribute("style")}if(r=="+"){document.getElementById(o).style.backgroundColor="#ffb7c5"}if(r=="-"){document.getElementById(o).style.backgroundColor="#8ab9f1"}if(n){let e=g.getProperty(n.sPath)[l+1e4];switch(e){case"pinkLevel1":document.getElementById(o).style.backgroundColor="#fddde6";break;case"pinkLevel2":document.getElementById(o).style.backgroundColor="#ffb7c5";break;case"pinkLevel3":document.getElementById(o).style.backgroundColor="#f99494";break;case"blueLevel1":document.getElementById(o).style.backgroundColor="#add8e6";break;case"blueLevel2":document.getElementById(o).style.backgroundColor="#8ab9f1";break;case"blueLevel3":document.getElementById(o).style.backgroundColor="#4166f5";break}}}}},exportExcel:function(e){let t=e.getSource().getParent().getParent();let l="";let a=t.getParent().getName();let n=g.bindList("/output");let r=f;let p=new o(t.getBinding().aFilters,true);let u=t.getBinding().aApplicationFilters;if(p!=[]&&u!=[]){n.filter(p,"Control");n.filter(u,"Application")}else if(p!=[]){n.filter(p,"Control")}else{n.filter(u,"Application")}let d=[];d.push({label:"Large classification",property:"LARGECLS",width:"5"});d.push({label:"Minor classification",property:"MINORCLS",width:"30"});d.push({label:"Name of dependent variable",property:"DEPVARNAME",width:"25"});d.push({label:"Explanatory variable number",property:"EXLVARNUM",width:"15"});d.push({label:"Explanatory variable name",property:"EXLVARNAME",width:"30"});d.push({label:"Flag",property:"FLAG",width:"30"});d.push({label:"Desired correlation",property:"DESIREDCORR",width:"30"});switch(a){case"KPIxPBR Matrix":for(let e=0;e<=r;e++){d.push({label:e.toString(),property:e.toString(),type:sap.ui.export.EdmType.Number,scale:9,width:12})}l="KPI-PBRMatrix.xlsx";break;case"Freedom adjust coefficent":for(let e=0;e<=r;e++){d.push({label:e.toString(),property:(e+100).toString(),type:sap.ui.export.EdmType.Number,scale:9,width:12})}l="KPI-PBRMatrix-Freedom Adjust Coefficent.xlsx";break;case"P-Value":for(let e=0;e<=r;e++){d.push({label:e.toString(),property:(e+1e3).toString(),type:sap.ui.export.EdmType.Number,scale:9,width:12})}l="KPI-PBRMatrix - P-value.xlsx";break}let c={workbook:{columns:d},dataSource:n,fileName:l};let m=new i(c);m.build().then(function(){s.show("Spreadsheet export has finished")}).finally(function(){m.destroy()})},xlsxExport:function(e){let t=this.getView().getModel().oData.treeOutput;let l=this.getView().getModel().oData.output;let a=Object.keys(l);var i=XLSX.utils.json_to_sheet(l);const n={bgColor:{rgb:"3832DC"}};for(let e in i){if(typeof i[e]=="object"){if(i[e].t=="n"){if(i[e].v<0){i[e].s={fill:{patternType:"solid",fgColor:{rgb:"b2b2b2"},bgColor:{rgb:"b2b2b2"}},font:{name:"宋体",sz:24,bold:true,color:{rgb:"FFAA00"}}}}}}}console.log(i);var s=XLSX.utils.book_new();XLSX.utils.book_append_sheet(s,i,"People");console.log(s);XLSX.writeFile(s,"sheetjs.xlsx",{cellStyles:"true"})},_newTreeTable:function(e){let l=this;let a=new t({icon:"sap-icon://decline",tooltip:"Clear all filters"}).attachPress(l._clearAllFilter,l);let i=new sap.m.SearchField({placeholder:"Filter",value:"{searchField>/globalFilter}",width:"15rem"}).attachSearch(l.searchGlobally,l);let s=new t({icon:"sap-icon://excel-attachment",tooltip:"Export Excel File"}).attachPress(l.exportExcel,l);let o=new sap.m.Toolbar({content:[new sap.m.ToolbarSpacer({}),a,i,s]});let r=this._newFixedColumns();let p=new n(e,{selectionMode:"None",rows:"{path:'/treeOutput', parameters: {arrayNames:['categories']}}",extension:o,columns:r,visibleRowCountMode:sap.ui.table.VisibleRowCountMode.Auto});return p},searchGlobally:function(e){let t=e.getParameters("query").query;let l=e.getSource().getParent().getParent();console.log(l.getBinding());let a=null;if(t){a=new o([new o("LARGECLS",r.Contains,t),new o("MINORCLS",r.Contains,t),new o("EXLVARNAME",r.Contains,t),new o("DESIREDCORR",r.Contains,t),new o("FLAG",r.Contains,t)],false)}l.getBinding().filter(a,"Application")},_clearAllFilter:function(e){let t=e.getSource().getParent().getParent();let l=this.getView().getModel("searchField");l.setProperty("/globalFilter","");t.getBinding().filter(null,"Application");t.getBinding().filter(null,"Control");var a=t.getColumns();for(var i=0;i<a.length;i++){t.filter(a[i],null)}},_newFixedColumns:function(){let e=[new sap.ui.table.Column({width:"12rem",multiLabels:[new sap.m.Label({visible:false}),new sap.m.Label({text:"Hierarchy"})],template:new sap.m.Text({text:"{name}",tooltip:"{name}"})}),new sap.ui.table.Column({width:"4rem",filterProperty:"LARGECLS",multiLabels:[new sap.m.Label({visible:false}),new sap.m.Label({text:"Large classification"})],template:new sap.m.Text({text:"{LARGECLS}",tooltip:"{LARGECLS}",maxLines:2})}),new sap.ui.table.Column({width:"11rem",filterProperty:"MINORCLS",multiLabels:[new sap.m.Label({visible:false}),new sap.m.Label({text:"Minor classification"})],template:new sap.m.Text({text:"{MINORCLS}",tooltip:"{MINORCLS}",maxLines:2})}),new sap.ui.table.Column({width:"5rem",filterProperty:"EXLVARNUM",multiLabels:[new sap.m.Label({visible:false}),new sap.m.Label({text:"Explanatory variable number"})],template:new sap.m.Text({text:"{EXLVARNUM}",maxLines:2})}),new sap.ui.table.Column({width:"11rem",filterProperty:"EXLVARNAME",multiLabels:[new sap.m.Label({visible:false}),new sap.m.Label({text:"Explanatory variable name"})],template:new sap.m.Text({text:"{EXLVARNAME}",tooltip:"{EXLVARNAME}",maxLines:2})}),new sap.ui.table.Column({width:"3rem",filterProperty:"FLAG",multiLabels:[new sap.m.Label({visible:false}),new sap.m.Label({text:"FLAG"})],template:new sap.m.Text({text:"{FLAG}",tooltip:"{FLAG}"})}),new sap.ui.table.Column({width:"3rem",filterProperty:"DESIREDCORR",multiLabels:[new sap.m.Label({visible:false}),new sap.m.Label({text:"Desired correlation"})],template:new sap.m.Text({text:"{DESIREDCORR}",tooltip:"{DESIREDCORR}"})})];return e},_renameKey:function(e,t){let l=[];for(let a=0;a<e.length;a++){let i=e[a];let n=i[t[0]];let s=i[t[1]];let o=i[t[2]];let r=i[t[3]].toString();let p=i[t[4]];let u=i[t[5]];let d=i[t[6]].toString();let c=parseFloat(i[t[7]]).toString();let g=parseFloat(i[t[8]]).toString();let f=parseFloat(i[t[9]]);l.push({MAJ_CLASS:n,MIN_CLASS:s,DEP_NAME:o,EXPL_VAR:r,EXPL_VAR_NAME_2:p,DESIRED_CORR:u,SHIFT_YEAR:d,RE_COEFFICIENT_2:c,DE_COEFFICIENT_AFT:g,P_VAL_2:f})}return l},getInput:function(e){let t=this.getView();let l=`/graph/getInputWithClient(client='${e}')`;let a,i;let n=this;let o=t.getModel();t.setBusy(true);$.ajax({type:"GET",url:l,cache:false,success:function(e){t.setBusy(false);i=e.value;if(i.length>0){o.setProperty("/input",i);console.log(i);a=Object.keys(i[0]);n._displayTreeTables(a,i);n._prepareFlatData(a,i)}else{d.show("Client has no data")}},error:function(e){t.setBusy(false);console.log(e);s.show("Request fails")}})},getInput_R:function(){let e=this.getView();let t=e.getModel();let l=this._inputFieldsValidCode();console.log("valid code",l);if(l=="0"){this.displayWarningDialog("Warning","Please choose a client");return}if(l=="10"||l=="11"){this.displayWarningDialog("Warning","Please choose an existed client");return}if(l=="20"||l=="21"){this.displayWarningDialog("Warning","Please choose an existed item");return}let a=t.getProperty("/SelectedClient");let i=t.getProperty("/SelectedClientItem");let n=`/graph/getOverlookingAnalysis(client='${a}',client_item='${i}')`;let o,r;let p=this;e.setBusy(true);$.ajax({type:"GET",url:n,cache:false,success:function(l){e.setBusy(false);r=l.value;console.log(r);if(r.length>0){t.setProperty("/input",r);console.log(r);o=Object.keys(r[0]);p._displayTreeTables_R(o,r);p._prepareFlatData_R(o,r)}else{d.show("Client has no data")}},error:function(t){e.setBusy(false);console.log(t);s.show("Request fails")}})},onSuggest:function(e){var t=e.getParameter("suggestValue"),l=[];if(t){l.push(new o("CLIENT",r.Contains,t))}console.log(e.getSource().getBinding("suggestionItems"));e.getSource().getBinding("suggestionItems").filter(l)},handleValueHelp:function(e){var t=this.getView();let l="catalog.view.ValueHelpDialog";this._sInputId=e.getSource().getId();this._sDialogName=e.getSource().getPlaceholder();if(e.getSource().getPlaceholder()=="Client Item")l="catalog.view.ClientItemDialog";this._pValueHelpDialog=p.load({id:t.getId(),name:l,controller:this}).then(function(e){t.addDependent(e);return e});this._pValueHelpDialog.then(function(e){e.open()})},_handleValueHelpSearch:function(e){var t=e.getParameter("value");let l=this._sDialogName=="Client"?"CLIENT":"CLIENT_ITEM";var a=new o(l,r.Contains,t);e.getSource().getBinding("items").filter([a])},_handleValueHelpClose:function(e){var t=e.getSource().getBinding("items");t.filter([]);var l=e.getParameter("selectedContexts");if(l&&l.length){var a=this.byId(this._sInputId);if(this._sDialogName=="Client"){a.setValue(l[0].getObject().CLIENT);this._setClientItemModel()}else{a.setValue(l[0].getObject().CLIENT_ITEM);this.getInput_R(l[0].getObject().CLIENT,l[0].getObject().CLIENT_ITEM)}}},fetchClients:function(){let e=this.getView().getModel();let t=this;$.ajax({type:"GET",url:"/graph/fetchClients()",cache:false,success:function(l){let a=l.value;let i={};let n=[];a.forEach(e=>{if(!i[e.CLIENT]){i[e.CLIENT]=[e];n.push({CLIENT:e.CLIENT})}else i[e.CLIENT].push(e)});console.log(i);e.setProperty("/groupedClients",i);e.setProperty("/Clients",n);t._setClientItemModel()},error:function(e){console.log(e)}});e.refresh()},_inputFieldsValidCode:function(){let e=this.getView().getModel();let t=e.getProperty("/SelectedClient").trim();let l=e.getProperty("/SelectedClientItem").trim();let a=e.getProperty("/Clients");let i=e.getProperty("/ClientItem");console.log(a);if(t==undefined||t.trim()=="")return"0";let n=a.find(e=>e.CLIENT==t);console.log(n);if(n){if(l==undefined||l.trim()=="")return"20";let e=i.find(e=>e.CLIENT_ITEM==l);if(e)return"22";return"21"}else{if(l==undefined||l.trim()=="")return"10";else return"11"}},_deleteClient:function(e){let l=this.getView();let a=this;let i,n;let o;console.log(e.getSource().getParent());let r=e.getSource().getParent().getCells()[0].getTitle();if(this._sDialogName=="Client"){i=r;n=undefined;o=new sap.m.Text({text:`All Client items belong to Client ${i} will be deleted. Do you want to delete the Client ${i}?`})}else{let e=l.getModel().getProperty("/ClientItem");let t=e.find(e=>e.CLIENT_ITEM==r);i=t.CLIENT;n=t.CLIENT_ITEM;o=new sap.m.Text({text:`Do you want to delete Client ${i} Client item ${n}`})}this.oApproveDialog=new u({type:b.Message,title:"Confirm",content:o,beginButton:new t({type:h.Emphasized,text:"Yes",press:function(){l.setBusy(true);$.ajax({type:"GET",url:`/graph/deleteInputofClient(client='${i}',client_item='${n}')`,cache:false,success:function(e){a.getView().getModel().setProperty("/treeOutput",[]);a.getView().getModel().setProperty("/output",[]);s.show(`Client ${i}${n?"("+n+")":""} has been removed`);let t=a._sInputId;a.byId(t).setValue();a.fetchClients();l.setBusy(false)},error:function(e){l.setBusy(false)}});this.oApproveDialog.close()}.bind(this)}),endButton:new t({text:"Cancel",press:function(){this.oApproveDialog.close()}.bind(this)})});this.oApproveDialog.open()},upload:function(){let e=this._inputFieldsValidCode();let l=this.getView().getModel();let a;let i=l.getProperty("/SelectedClient").trim();let n=l.getProperty("/SelectedClientItem").trim();let s=this;let o=l.getProperty("/input");if(e=="0"){this.displayWarningDialog("Warning","Please choose a client");return}if(e=="10"||e=="20"){this.displayWarningDialog("Warning","Please choose a client item");return}if(e=="22"){a=new sap.m.Text({text:`Upload data will be overrided to Client ${i} - ${n}. Do you want to save to database ?`})}else{a=new sap.m.Text({text:`Do you want to save to database ?`})}this.oUploadDialog=new u({type:b.Message,title:"Confirm",content:a,beginButton:new t({type:h.Emphasized,text:"Yes",press:function(){this._uploadDB(i,n,o);this.oUploadDialog.close()}.bind(this)}),endButton:new t({text:"Cancel",press:function(){this.oUploadDialog.close()}.bind(this)})});this.oUploadDialog.open()},_uploadDB:async function(e,t,l){let a=Object.assign([],l);let i=this.getView();i.setBusy(true);let n=this;await $.ajax({url:`/graph/deleteInputofClient(client='${e}',client_item='${t}')`,type:"GET",beforeSend:function(e){e.setRequestHeader("X-Requested-With","XMLHttpRequest");e.setRequestHeader("Content-Type","application/atom+xml");e.setRequestHeader("DataServiceVersion","2.0");e.setRequestHeader("X-CSRF-Token","Fetch")},success:function(l,s,o){var r=o.getResponseHeader("X-CSRF-Token");console.log(r);let p;if(r!=null||r!=undefined){p={"X-CSRF-Token":r,"Content-Type":"application/json"}}else{p={"Content-Type":"application/json"}}for(let l=0;l<a.length;l++){a[l].CLIENT=e;a[l].CLIENT_ITEM=t;a[l].SEQUENCE_NO=l.toString()}$.ajax({type:"POST",url:"/graph/upload",data:JSON.stringify({uploadData:a}),headers:p,cache:false,success:function(e){console.log("success",e);i.setBusy(false);d.show("Success",{title:"Upload Completed"});n.fetchClients()},error:function(e){console.log("error",e);i.setBusy(false);d.show("Server is busy now, please try again",{title:"Upload Failed"})}})}.bind(this),error:function(e){d.alert("Serve is busy now, please try again");i.setBusy(false);console.log(e)}.bind(this)})},displayWarningDialog:function(e,l){let a=new u({type:b.Message,title:e,state:L.Warning,content:new sap.m.Text({text:l}),beginButton:new t({type:h.Emphasized,text:"OK",press:function(){a.close()}.bind(this)})});a.open()},_setClientItemModel:function(){let e=this.getView().getModel();let t=e.getProperty("/SelectedClient");if(t!=undefined&&t.trim()!=""){let l=e.getProperty("/groupedClients");e.setProperty("/ClientItem",l[t])}else{e.setProperty("/ClientItem",[])}}})});